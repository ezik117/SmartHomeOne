# СИСТЕМА ДОМАШНЕГО ВИДЕОКОНТРОЛЯ ПРОНИКНОВЕНИЯ В ПОМЕЩЕНИЕ
# "SMART HOME ONE"
(Версия 1.0. / Release date: 19.06.2020)

## 1. ОПИСАНИЕ
Простая система видеоконтроля помещения. Позволяет вести видеозапись с USB-камеры по сигналу тревоги. Задается время видеозаписи, время между записью видео при повторном сигнале тревоги. <br>
В качестве внешнего источника сигнала тревоги могут быть применены:
- геркон (нормальноразомкнутый)
- кнопка (типа сухой контакт, нормальноразомкнутая)
- датчик движения (нормальноразомкнутый)
- любое устройство формирующее TTL сигнал положительной полярности.
  
Записанные изображения и видеофайлы автоматически загружаются на Яндекс Диск.

Также можно управлять системой через клиент мессенджера Telegram (для этого нужно создать Telegram-бота) и позволяет:
- имитировать сигнал тревоги
- производить запись короткого видео или делать фото с отправкой напрямую в Telegram
- перезагружать систему

Для работы системы требуются всего два файла:
- smarthomeone.py
- smarthomeconfig.ini

## 2. ПЕРИФЕРИЯ
<table border="1">
<tr>
	<td><b>Одноплатный компьютер Raspberry Pi</b></td>
	<td>Рекомендуемая модель: Raspberry Pi 4 B+ (16Гб Flash). Базовая система.</td>
</tr>
<tr>
	<td><b>Индикатор HEALTH</b> (опционально)</td>
	<td>(GPIO20) Светодиод. Показывает текущее состояние системы. <i>Выключен</i> - в процессе работы программы возникла неустранимая ошибка, работа программы прекращена или программа не запущена. <i>Включен</i> - система работает. <i>Мигает с частотой 1 сек</i> - инициализация системы. <i>Мигает с частотой 0.5 сек</i> - тревога.</td>
</tr>
<tr>
	<td><b>USB камера</b></td>
	<td>Любая USB камера. Рекомендуемые характеристики: >=3Мп, ИК-подсветка, автофокус.</td>
</tr>
<tr>
	<td><b>Источник тревоги</b></td>
	<td>(GPIO21) Любое тревожное устройство: датчик движения, герконовый контакт и т.п. Активный выходной уровень тревоги - высокий, пассивный контакт - размыкание генерирует тревогу . Рекомендуемое время удержания активного уровня не менее 1 секунды. Схему подключения смотри ниже.</td>
</tr>
</table>

## 3. ПРИНЦИП РАБОТЫ
- При запуске производится инициализация сервисов (индикатор HEALTH мигает с частотой 1 секунда):
 - Проверяется содержимое папки TEMP (папка для локального хранения временных файлов). Если в ней находятся еще не отправленные на Яндекс Диск файлы (например из-за перезагрузки системы), создается запрос на их отправку.
 - Производится попытка подключения к Яндекс Диску и Телеграм.
 - Измеряется значение FPS для оценки производительности системы и настройки частоты кадров в видеофайлах (для Raspberry PI 4 B+ составляет примерно 7-10 кадров в секунду).
- Если все предварительные настойки прошли успешно, включается индикатор HEALTH. В случае сбоя - индикатор не горит, программа не запускется, данные об ошибках записываются в файл <i>errorlog.txt</i>.
- Далее программа ожидает либо активации входа ALARM_IN, либо управляющей команды из Телеграм.

### 3.1. Действия при активном входе тревоги ALARM_IN
- Индикатор HEALTH начинает мигать с частотой 0.5 секунды.
- Происходит запись 1-минутного видеофайла (время может быть изменено в INI файле). Параллельно в установленные интервалы происходит сохранение отдельных фотографий (первая в начале записи, затем согласно интервалу). Файлы записывются в локальную папку TEMP.
- Параллельно происходит отправка готовых фотографий из папки TEMP на Яндекс Диск. По завершении записи видео, оно тоже загружается. По мере загрузки файлов на Яндекс Диск, они удаляются из папки TEMP.
- На Яндекс Диске файлы сохраняются в папку вида <i>(<номер видеоустройства>)_<дата></i> с порядковым номером файла. Таким образом структура папки будет выглядеть примерно так:
  - <b>(0)_2020_06_14_1345</b>
    - video.mp4
	- 0.jpg
	- 1.jpg
	- 2.jpg
	- ...
- Если в процессе записи видео поступил еще один сигнал тревоги, он не будет обработан.
- После окончания записи видео, новый сигнал тревоги не будет обработан до истечения интервала указанного в INI файле. Интервал считается между детектированием сигнала тревоги, а не окончания записи видео.

### 3.2. Действия при получении управляющих команд с Телеграм
<i>Внимание! В процессе фото-видео записи запущенных с Телеграм - вход ALARM_IN отключается. Тревоги с ALARM_IN обработаны не будут.</i><br>

#### /start
Получить текущий статус программы. Служит для проверки состояния программы.
#### /myip
Получить внешний IP адрес. 
#### /shot
Сделать фотографию с вебкамеры и отправить по Телеграм.
#### /video
Сделать 10 секундное видео (время может быть изменено в INI файле) с вебкамеры (формат MP4V) и отправить по Телеграм.<br>
<i>Справочно: 1 секунда = 112Кб, при FPS=10 и разрешении 640х480.</i>
#### /alarm
Симуляция срабатывания тревоги (ALARM_IN). Происходит запись с камеры, как если бы в режиме тревоги. Фото и видео загружаются на Яндекс Диск.
#### /reset
Перезагружает Raspberry Pi.
#### /help
Вызов справки по командам.

## 4. НАСТРОЙКА RASPBERRY PI

#### Телеграм
<code>pip3 install pyTelegramBotAPI</code><br>
Так же необходимо получить TOKEN для Телеграм-бота:
- Найдите в Телеграм бота @BotFather
- Выполните команду /start и следуйте указаниям бота

#### Яндекс Диск
<code>pip3 install yadisk</code><br>
Для сохранения на Яндекс Диск нужно получить OAuth TOKEN доступа. Для этого:
- Зарегистрируйте приложение здесь https://oauth.yandex.ru/client/new
- При регистрации отметьте только Яндекс Диск.
- После регистрации Вы получите ID приложения.
- Вставьте ID в этот адрес и получите Token <u>https://oauth.yandex.ru/authorize?response_type=token&client_id=<ID приложения>&display=popup</u>

#### Windscribe
Windscribe необходим для установки VPN соединения, т.к. на территории России Telegram заблокирован.<br>
Инструкция по установке находится <a href="https://windscribe.com/guides/linux#how-to">здесь</a>
После установки Windscribe нужно однократно авторизоваться в системе.

#### OpenCV
Взято из <a href="https://www.pyimagesearch.com/2019/09/16/install-opencv-4-on-raspberry-pi-4-and-raspbian-buster/">этого источника</a>.
<p>
Вначале ставим необходимые пакеты (здесь убраны пакеты вывода графики на экран):<br>
<code>$ sudo apt-get update && sudo apt-get upgrade</code><br>
<code>$ sudo apt-get install build-essential cmake pkg-config</code><br>
<code>$ sudo apt-get install libjpeg-dev libtiff5-dev libjasper-dev libpng-dev</code><br>
<code>$ sudo apt-get install libavcodec-dev libavformat-dev libswscale-dev libv4l-dev</code><br>
<code>$ sudo apt-get install libxvidcore-dev libx264-dev</code><br>
<code>$ sudo apt-get install libatlas-base-dev gfortran</code><br>
<code>$ sudo apt-get install libhdf5-dev libhdf5-serial-dev libhdf5-103</code><br>
<code>$ sudo apt-get install libqtgui4 libqtwebkit4 libqt4-test python3-pyqt5</code>
</p>
<p>
Теперь ставим саму библиотеку в Python (важно указать версию!):<br>
<code>$ pip install opencv-contrib-python==4.1.0.25</code>
</p>

#### Другое
<p>
Для получения внешнего IP адреса нам понадобится утилита DIG входяшая в состав DNSUTILS<br>
<code>sudo apt-get install dnsutils</code>
</p>
Так же понадобятся модули:<br>
<code>pip install imutils</code>

## 5. НАСТРОЙКИ ПРОГРАММЫ
Все настройки программы задаются в файле SMARTHOMECONFIG.INI.

## 6. СХЕМА ПОДКЛЮЧЕНИЯ
<img src="https://github.com/ezik117/SmartHomeOne/blob/master/images/schematic_diagram.png">
